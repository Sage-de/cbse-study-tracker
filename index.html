<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arc Cards</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --border: #e5e5ea;
      --accent: #0071e3;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --shadow-xs: 0 1px 2px rgba(0,0,0,.06);
      --shadow-sm: 0 4px 12px rgba(0,0,0,.06);
      --shadow-md: 0 10px 30px rgba(0,0,0,.06);
      --shadow-lg: 0 20px 60px rgba(0,0,0,.10);
      --fz-12: 12px;
      --fz-14: 14px;
      --fz-16: 16px;
      --fz-20: 20px;
      --fz-24: 24px;
      --trans-fast: .12s cubic-bezier(.2,.8,.2,1);
      --trans: .2s cubic-bezier(.2,.8,.2,1);
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0b0c;
        --surface: #151516;
        --text: #f5f5f7;
        --muted: #9a9aa0;
        --border: #2a2a2b;
        --accent: #0a84ff;
        --shadow-xs: 0 1px 2px rgba(0,0,0,.4);
        --shadow-sm: 0 4px 12px rgba(0,0,0,.35);
        --shadow-md: 0 10px 30px rgba(0,0,0,.4);
        --shadow-lg: 0 20px 60px rgba(0,0,0,.5);
      }
    }
    [data-theme="light"] { --bg: #f5f5f7; --surface: #ffffff; --text: #1d1d1f; --muted: #6e6e73; --border: #e5e5ea; --accent: #0071e3; --shadow: 0 10px 30px rgba(0,0,0,.06); }
    [data-theme="dark"] { --bg: #0b0b0c; --surface: #151516; --text: #f5f5f7; --muted: #9a9aa0; --border: #2a2a2b; --accent: #0a84ff; --shadow: 0 10px 30px rgba(0,0,0,.4); }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: 100%;
    }

    .sidebar {
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      background: linear-gradient(180deg, var(--surface), color-mix(in oklab, var(--surface), var(--bg) 25%));
    }

    .brand {
      display: flex; justify-content: space-between; align-items: center; gap: 8px;
      margin-bottom: 16px;
    }

    .title { font-size: 20px; font-weight: 600; letter-spacing: .2px; }
    .muted { color: var(--muted); font-size: 12px; }

    .deck-list { margin-top: 12px; display: grid; gap: 6px; }
    .deck {
      display: flex; align-items: center; justify-content: space-between; gap: var(--space-2);
      padding: 10px 12px; border-radius: var(--radius-md); border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      transition: transform var(--trans), box-shadow var(--trans);
    }
    .deck:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .deck.active { outline: 2px solid color-mix(in oklab, var(--accent), white 40%); }

    .deck-name { font-weight: 600; }
    .deck-count { font-variant-numeric: tabular-nums; }

    .add-row { display: flex; gap: 8px; margin-top: 12px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: color-mix(in oklab, var(--muted), var(--text) 10%); }

    .btn {
      appearance: none; -webkit-appearance: none;
      padding: 10px 14px; border-radius: var(--radius-md); border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in oklab, var(--surface), white 4%), var(--surface));
      color: var(--text); cursor: pointer; font-weight: 600;
      transition: transform .05s ease, box-shadow var(--trans), background var(--trans);
    }
    .btn:focus-visible { outline: 2px solid color-mix(in oklab, var(--accent), white 35%); outline-offset: 2px; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: color-mix(in oklab, var(--accent), black 20%); background: linear-gradient(180deg, color-mix(in oklab, var(--accent), white 15%), var(--accent)); color: white; }
    .btn.ghost { background: transparent; }
    .btn.danger { border-color: #e04848; color: #e04848; background: transparent; }

    .topbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); }

    .content { padding: 24px; overflow: auto; }
    .panel { max-width: 920px; margin: 0 auto; display: grid; gap: 16px; }

    .card { border: 1px solid var(--border); border-radius: 16px; background: var(--surface); box-shadow: var(--shadow); padding: 16px; }

    .flashcard { border-radius: 20px; padding: 36px; text-align: center; font-size: 22px; font-weight: 600; letter-spacing: .2px; }
    .flashcard .back { margin-top: 16px; font-weight: 500; color: var(--muted); }

    .answer-row { display: flex; gap: 12px; justify-content: center; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }

    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } .sidebar { border-right: none; border-bottom: 1px solid var(--border); } .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="root" class="app"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const DS = {
      Button({ children, variant = 'default', className = '', ...props }) {
        const cls = ['btn', variant === 'primary' ? 'primary' : '', variant === 'ghost' ? 'ghost' : '', variant === 'danger' ? 'danger' : '', className].filter(Boolean).join(' ');
        return <button className={cls} {...props}>{children}</button>;
      },
      Input({ className = '', ...props }) {
        return <input className={className} style={{ width: '100%', padding: '10px 12px', background: 'var(--surface)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 'var(--radius-md)', outline: 'none' }} {...props} />
      },
      Textarea({ className = '', rows = 3, ...props }) {
        return <textarea className={className} rows={rows} style={{ width: '100%', padding: '10px 12px', background: 'var(--surface)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 'var(--radius-md)', outline: 'none' }} {...props} />
      },
      Select({ className = '', children, ...props }) {
        return <select className={className} style={{ width: '100%', padding: '10px 12px', background: 'var(--surface)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 'var(--radius-md)', outline: 'none' }} {...props}>{children}</select>;
      },
      Card({ children, className = '', ...props }) {
        return <div className={['card', className].filter(Boolean).join(' ')} {...props}>{children}</div>;
      },
      Title({ children }) { return <div style={{ fontWeight: 700, fontSize: 'var(--fz-16)' }}>{children}</div>; },
      Subtle({ children }) { return <div className="muted">{children}</div>; },
    };

    const storeKey = 'arc-cards';
    const prefKey = 'arc-cards-theme';
    const CURRENT_SCHEMA_VERSION = 2;
    const uid = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

    function migrate(raw) {
      if (!raw || typeof raw !== 'object') return { version: CURRENT_SCHEMA_VERSION, decks: [], cards: [] };
      if (raw.version === undefined) {
        const decks = (raw.decks || []).map(d => ({ id: d.id || uid(), name: String(d.name || 'Untitled'), createdAt: d.createdAt || Date.now(), updatedAt: Date.now(), color: d.color || null }));
        const cards = (raw.cards || []).map(c => ({
          id: c.id || uid(),
          deckId: c.deckId,
          front: String(c.front || ''),
          back: String(c.back || ''),
          tags: Array.isArray(c.tags) ? c.tags : [],
          ease: typeof c.ease === 'number' ? c.ease : 2.5,
          interval: typeof c.interval === 'number' ? c.interval : 0,
          reps: typeof c.reps === 'number' ? c.reps : 0,
          lapses: typeof c.lapses === 'number' ? c.lapses : 0,
          dueAt: typeof c.dueAt === 'number' ? c.dueAt : Date.now(),
          createdAt: c.createdAt || Date.now(),
          updatedAt: Date.now(),
          learningStage: c.learningStage || 0
        }));
        raw = { version: 1, decks, cards };
      }
      if (raw.version === 1) {
        raw = { ...raw, version: 2 };
      }
      return raw;
    }

    function load() {
      try {
        const storedV2 = JSON.parse(localStorage.getItem(storeKey + '-v2'));
        if (storedV2 && storedV2.version) return storedV2;
      } catch {}
      try {
        const legacy = JSON.parse(localStorage.getItem(storeKey + '-v1')) || JSON.parse(localStorage.getItem('arc-cards-v1')) || JSON.parse(localStorage.getItem('arc-cards')) || null;
        const migrated = migrate(legacy || { decks: [], cards: [] });
        save(migrated);
        return migrated;
      } catch {
        const empty = { version: CURRENT_SCHEMA_VERSION, decks: [], cards: [] };
        save(empty);
        return empty;
      }
    }
    function save(state) { localStorage.setItem(storeKey + '-v2', JSON.stringify(state)); }

    function useTheme() {
      const [theme, setTheme] = useState(() => localStorage.getItem(prefKey) || 'system');
      useEffect(() => {
        const root = document.documentElement;
        root.removeAttribute('data-theme');
        if (theme === 'light' || theme === 'dark') root.setAttribute('data-theme', theme);
        localStorage.setItem(prefKey, theme);
      }, [theme]);
      return [theme, setTheme];
    }

    function TopBar({ theme, setTheme }) {
      return (
        <div className="topbar">
          <div>
            <div style={{ fontWeight: 700, letterSpacing: .2 }}>Arc Cards</div>
            <div className="muted">Local-first flashcards</div>
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <DS.Select value={theme} onChange={e => setTheme(e.target.value)}>
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </DS.Select>
          </div>
        </div>
      );
    }

    function Sidebar({ decks, activeId, setActiveId, addDeck, deleteDeck }) {
      const [name, setName] = useState('');
      return (
        <aside className="sidebar">
          <div className="brand">
            <div>
              <div className="title">Decks</div>
              <div className="muted">Study by collection</div>
            </div>
          </div>
          <div className="deck-list">
            {decks.map(d => (
              <div key={d.id} className={`deck ${activeId === d.id ? 'active' : ''}`}>
                <DS.Button variant="ghost" style={{ padding: 0, border: 'none', background: 'transparent', textAlign: 'left', flex: 1 }} onClick={() => setActiveId(d.id)}>
                  <div className="deck-name">{d.name}</div>
                  <div className="muted deck-count">{d.count ?? 0} cards</div>
                </DS.Button>
                <DS.Button variant="danger" onClick={() => deleteDeck(d.id)}>Delete</DS.Button>
              </div>
            ))}
          </div>
          <div className="add-row">
            <DS.Input value={name} onChange={e => setName(e.target.value)} placeholder="New deck" />
            <DS.Button variant="primary" onClick={() => { const n = name.trim(); if (!n) return; addDeck(n); setName(''); }}>Add</DS.Button>
          </div>
        </aside>
      );
    }

    function CardEditor({ deck, addCard, importDeck, exportDeck }) {
      const [front, setFront] = useState('');
      const [back, setBack] = useState('');
      return (
        <DS.Card>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div style={{ fontWeight: 700 }}>Add Card — {deck?.name || ''}</div>
            <div style={{ display: 'flex', gap: 8 }}>
              <DS.Button onClick={exportDeck}>Export</DS.Button>
              <label className="btn" style={{ display: 'inline-flex', alignItems: 'center', gap: 8 }}>
                Import
                <input type="file" accept="application/json" style={{ display: 'none' }} onChange={e => importDeck(e.target.files?.[0] || null)} />
              </label>
            </div>
          </div>
          <div className="grid-2" style={{ marginTop: 12 }}>
            <DS.Textarea value={front} onChange={e => setFront(e.target.value)} rows={3} placeholder="Front" />
            <DS.Textarea value={back} onChange={e => setBack(e.target.value)} rows={3} placeholder="Back" />
          </div>
          <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: 12 }}>
            <DS.Button variant="primary" onClick={() => { const f = front.trim(); const b = back.trim(); if (!f || !b) return; addCard(f, b); setFront(''); setBack(''); }}>Add Card</DS.Button>
          </div>
        </DS.Card>
      );
    }

    function StudyView({ card, flip, isFlipped, answer }) {
      if (!card) return (
        <DS.Card style={{ textAlign: 'center' }}>
          <div className="muted">No cards due. Add more or come back later.</div>
        </DS.Card>
      );
      return (
        <DS.Card>
          <div className="flashcard" onClick={flip} style={{ cursor: 'pointer' }}>
            <div>{card.front}</div>
            {isFlipped && <div className="back">{card.back}</div>}
          </div>
          <div className="answer-row">
            <DS.Button onClick={() => answer('again')}>Again</DS.Button>
            <DS.Button variant="primary" onClick={() => answer('good')}>Good</DS.Button>
            <DS.Button onClick={() => answer('easy')}>Easy</DS.Button>
          </div>
        </DS.Card>
      );
    }

    function CardTable({ cards, deleteCard }) {
      return (
        <DS.Card>
          <div style={{ fontWeight: 700, marginBottom: 8 }}>Cards</div>
          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <thead>
                <tr style={{ textAlign: 'left', color: 'var(--muted)', fontSize: 12 }}>
                  <th style={{ padding: 8 }}>Front</th>
                  <th style={{ padding: 8 }}>Back</th>
                  <th style={{ padding: 8 }}>Due</th>
                  <th style={{ padding: 8 }}></th>
                </tr>
              </thead>
              <tbody>
                {cards.map(c => (
                  <tr key={c.id} style={{ borderTop: '1px solid var(--border)' }}>
                    <td style={{ padding: 8 }}>{c.front}</td>
                    <td style={{ padding: 8, color: 'var(--muted)' }}>{c.back}</td>
                    <td style={{ padding: 8 }}>{new Date(c.dueAt || Date.now()).toLocaleString()}</td>
                    <td style={{ padding: 8, textAlign: 'right' }}>
                      <DS.Button variant="danger" onClick={() => deleteCard(c.id)}>Delete</DS.Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </DS.Card>
      );
    }

    function App() {
      const [theme, setTheme] = useTheme();
      const [data, setData] = useState(() => {
        const s = load();
        if (s.decks.length === 0) {
          const d1 = { id: uid(), name: 'Mathematics' };
          const d2 = { id: uid(), name: 'Science' };
          s.decks = [d1, d2];
          s.cards = [
            { id: uid(), deckId: d1.id, front: 'What is 2 + 2?', back: '4', interval: 0, ease: 2.5, reps: 0, dueAt: Date.now() },
            { id: uid(), deckId: d2.id, front: 'State of matter at room temp for oxygen?', back: 'Gas', interval: 0, ease: 2.5, reps: 0, dueAt: Date.now() }
          ];
          save(s);
        }
        return s;
      });
      const [activeId, setActiveId] = useState(() => data.decks[0]?.id || null);
      const [isFlipped, setFlipped] = useState(false);

      useEffect(() => { save(data); }, [data]);

      const decks = useMemo(() => data.decks.map(d => ({ ...d, count: data.cards.filter(c => c.deckId === d.id).length })), [data]);
      const activeDeck = useMemo(() => decks.find(d => d.id === activeId) || null, [decks, activeId]);
      const now = Date.now();
      const dueCards = useMemo(() => data.cards.filter(c => c.deckId === activeId && (c.dueAt || 0) <= now).sort((a,b) => (a.dueAt||0)-(b.dueAt||0)), [data, activeId, now]);
      const current = dueCards[0] || null;

      function addDeck(name) {
        const d = { id: uid(), name, createdAt: Date.now(), updatedAt: Date.now(), color: null };
        setData(s => ({ ...s, decks: [...s.decks, d] }));
        setActiveId(d.id);
      }
      function deleteDeck(id) {
        setData(s => ({ ...s, decks: s.decks.filter(d => d.id !== id), cards: s.cards.filter(c => c.deckId !== id) }));
        if (activeId === id) setActiveId(s => (decks.find(d => d.id !== id)?.id || null));
      }
      function addCard(front, back) {
        if (!activeDeck) return;
        const c = { id: uid(), deckId: activeDeck.id, front, back, tags: [], ease: 2.5, interval: 0, reps: 0, lapses: 0, learningStage: 0, dueAt: Date.now(), createdAt: Date.now(), updatedAt: Date.now() };
        setData(s => ({ ...s, cards: [c, ...s.cards] }));
      }
      function deleteCard(id) {
        setData(s => ({ ...s, cards: s.cards.filter(c => c.id !== id) }));
      }
      function flip() { setFlipped(v => !v); }

      function schedule(card, rating) {
        const nowMs = Date.now();
        const learningSteps = [10/60/24, 60/60/24];
        let { interval = 0, ease = 2.5, reps = 0, lapses = 0, learningStage = 0 } = card;
        if (interval === 0 || learningStage < learningSteps.length) {
          if (rating === 'again') {
            learningStage = 0;
            reps += 1;
            return { ...card, reps, lapses, interval: 0, ease, learningStage, dueAt: nowMs + learningSteps[0]*24*60*60*1000, updatedAt: nowMs };
          } else if (rating === 'good') {
            reps += 1;
            if (learningStage < learningSteps.length - 1) {
              learningStage += 1;
              return { ...card, reps, interval: 0, ease, learningStage, dueAt: nowMs + learningSteps[learningStage]*24*60*60*1000, updatedAt: nowMs };
            } else {
              interval = 1;
              learningStage = learningSteps.length;
              return { ...card, reps, interval, ease, learningStage, dueAt: nowMs + interval*24*60*60*1000, updatedAt: nowMs };
            }
          } else {
            reps += 1;
            interval = 3;
            learningStage = learningSteps.length;
            ease = Math.min(3.0, ease + 0.15);
            return { ...card, reps, interval, ease, learningStage, dueAt: nowMs + interval*24*60*60*1000, updatedAt: nowMs };
          }
        }
        if (rating === 'again') {
          lapses += 1;
          ease = Math.max(1.3, ease - 0.2);
          reps += 1;
          return { ...card, reps, lapses, interval: 0, ease, learningStage: 0, dueAt: nowMs + learningSteps[0]*24*60*60*1000, updatedAt: nowMs };
        }
        if (rating === 'good') {
          reps += 1;
          interval = Math.max(1, interval * ease);
          const millis = interval * 24 * 60 * 60 * 1000;
          return { ...card, reps, interval, ease, dueAt: nowMs + millis, updatedAt: nowMs };
        }
        reps += 1;
        ease = Math.min(3.0, ease + 0.15);
        interval = Math.max(3, interval * ease * 1.15);
        return { ...card, reps, interval, ease, dueAt: nowMs + interval*24*60*60*1000, updatedAt: nowMs };
      }
      function answer(r) {
        if (!current) return;
        const updated = schedule(current, r);
        setData(s => ({ ...s, cards: s.cards.map(c => c.id === current.id ? updated : c) }));
        setFlipped(false);
      }

      useEffect(() => {
        function onKey(e) {
          if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
          if (e.code === 'Space') { e.preventDefault(); flip(); }
          if (e.key === '1') answer('again');
          if (e.key === '2') answer('good');
          if (e.key === '3') answer('easy');
          if (e.key.toLowerCase() === 'j') setFlipped(true);
          if (e.key.toLowerCase() === 'k') setFlipped(false);
        }
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [current]);

      function exportDeck() {
        if (!activeDeck) return;
        const payload = { deck: activeDeck, cards: data.cards.filter(c => c.deckId === activeDeck.id) };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${activeDeck.name}.json`; a.click();
      }
      async function importDeck(file) {
        if (!file) return;
        const text = await file.text();
        try {
          const payload = JSON.parse(text);
          if (payload.deck && Array.isArray(payload.cards)) {
            const mapId = new Map();
            const newDeckId = uid();
            mapId.set(payload.deck.id, newDeckId);
            const newDeck = { id: newDeckId, name: payload.deck.name };
            const newCards = payload.cards.map(c => ({ ...c, id: uid(), deckId: newDeckId }));
            setData(s => ({ ...s, decks: [...s.decks, newDeck], cards: [...newCards, ...s.cards] }));
            setActiveId(newDeckId);
          }
        } catch {}
      }

      return (
        <div style={{ display: 'contents' }}>
          <Sidebar decks={decks} activeId={activeId} setActiveId={setActiveId} addDeck={addDeck} deleteDeck={deleteDeck} />
          <main role="main" aria-live="polite">
            <TopBar theme={theme} setTheme={setTheme} />
            <div className="content">
              <div className="panel">
                <StudyView card={current} flip={flip} isFlipped={isFlipped} answer={answer} />
                {activeDeck && <CardEditor deck={activeDeck} addCard={addCard} importDeck={importDeck} exportDeck={exportDeck} />}
                {activeDeck && <CardTable cards={data.cards.filter(c => c.deckId === activeDeck.id)} deleteCard={deleteCard} />}
              </div>
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
